#!/bin/bash
export GIT_REF=$(git rev-parse --short=8 HEAD)
export IMG_TAG="${GIT_REF}"
export BACK_APP_DIR="/backend"
export FRONT_APP_DIR="/frontend"

fn_help()
{
    echo "jc: JHEEP development cli"
    echo
    echo "Jinserk Baik <jinserk.baik@gmail.com>"
    echo "copyright (c) JHEE Group LLC"
    echo
    echo "default usage: "
    echo "  jc [help|-h|--help]         show this help"
    echo "  jc build                    build default docker image"
    echo "  jc up                       run compose env in background"
    echo "  jc down                     teardown compose env"
    echo "  jc logs                     show logs from the compose env"
    echo "  jc psql [<args>]            psql env in db container"
    echo "  jc jhee [<args>]            exec the jheep cli command in back container"
    echo "  jc bash [<args>]            exec bash in back container"
    echo
}

fn_login_to_github()
{
    if [ -f ${JHEEP_PATH}/.github/.pat ]; then
        . ${JHEEP_PATH}/.github/.pat
        echo ${CR_PAT} | docker login ghcr.io -u ${CR_USER} --password-stdin
    fi
}

##########
# main 

[[ $# -lt 1 ]] && fn_help && exit 1

docker_cmd="docker compose -f ${JHEEP_PATH}/docker-compose.yml"

case $1 in
    "up")
        ${docker_cmd} up -d --remove-orphans
        ;;
    "down")
        ${docker_cmd} down --remove-orphans
        ;;
    "logs")
        ${docker_cmd} logs -f
        ;;
    "build")
        ${docker_cmd} build
        ;;
    "push")
        fn_login_to_github
        ${docker_cmd} push
        ;;
    "psql")
        ${docker_cmd} exec db psql -U postgres ${@:2}
        ;;
    "jhee")
        ${docker_cmd} exec back jhee ${@:2}
        ;;
    "bash")
        ${docker_cmd} exec back bash ${@:2}
        ;;
    "help" | "-h" | "--help")
        fn_help
        ;;
    *)
        fn_help
        ;;
esac
